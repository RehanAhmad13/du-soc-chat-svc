<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>DU SOC Chat</title>
<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  rel="stylesheet"
  integrity="sha384-9ndCyUaPlFvJkP0gS3X3UJ46jBY6hU50PsvcmYj8Aqa8rZE+gyExQJZ9W5yXKbi6"
  crossorigin="anonymous"
/>
<style>
#messages { height: 40vh; overflow-y: auto; }
.sender { font-weight: bold; }
li { cursor: pointer; }
</style>
<script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
</head>
<body>
<div id="app"></div>
<script type="text/babel">
const { useState } = React;

function ChatApp() {
  const [token, setToken] = useState(null);
  const [threads, setThreads] = useState([]);
  const [currentThread, setCurrentThread] = useState(null);
  const [messages, setMessages] = useState([]);
  const [socket, setSocket] = useState(null);
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [newMessage, setNewMessage] = useState('');

  const login = () => {
    fetch('/api/chat/token/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    })
      .then(r => r.json())
      .then(data => {
        if (data.token) {
          setToken(data.token);
          loadThreads(data.token);
        } else {
          alert('Login failed');
        }
      });
  };

  const loadThreads = (tok = token) => {
    fetch('/api/chat/threads/', { headers: { 'Authorization': 'Bearer ' + tok } })
      .then(r => r.json())
      .then(setThreads);
  };

  const openThread = (thread) => {
    setCurrentThread(thread);
    setMessages([]);
    if (socket) socket.close();
    const ws = new WebSocket(`ws://${location.host}/ws/chat/${thread.id}/?token=${token}`);
    ws.onmessage = e => {
      const data = JSON.parse(e.data);
      if (data.type === 'message') {
        setMessages(prev => [...prev, { sender: data.sender, content: data.content }]);
      }
    };
    setSocket(ws);
    fetch(`/api/chat/threads/${thread.id}/`, { headers: { 'Authorization': 'Bearer ' + token } })
      .then(r => r.json())
      .then(d => {
        const msgs = d.messages || [];
        setMessages(msgs.map(m => ({ sender: m.sender, content: m.content })));
      });
  };

  const sendMessage = () => {
    if (!newMessage || !socket) return;
    socket.send(JSON.stringify({ type: 'message', content: newMessage }));
    setNewMessage('');
  };

  if (!token) {
    return (
      <div className="container py-5">
        <div className="mb-3">
          <input
            className="form-control"
            value={username}
            onChange={e => setUsername(e.target.value)}
            placeholder="Username"
            aria-label="Username"
          />
        </div>
        <div className="mb-3">
          <input
            type="password"
            className="form-control"
            value={password}
            onChange={e => setPassword(e.target.value)}
            placeholder="Password"
            aria-label="Password"
          />
        </div>
        <button className="btn btn-primary" onClick={login} aria-label="Login">Login</button>
      </div>
    );
  }

  if (!currentThread) {
    return (
      <div className="container py-5">
        <h1 className="mb-4">DU SOC Chat</h1>
        <h2 className="h5">Threads</h2>
        <ul className="list-group">
          {threads.map(t => (
            <li
              key={t.id}
              className="list-group-item list-group-item-action"
              onClick={() => openThread(t)}
            >
              {t.incident_id} (ID {t.id})
            </li>
          ))}
        </ul>
      </div>
    );
  }

  return (
    <div className="container py-5">
      <h1 className="mb-4">DU SOC Chat</h1>
      <h2 className="h5 mb-3">Incident {currentThread.incident_id}</h2>
      <div id="instructions" className="text-muted mb-2">
        Please answer any structured prompts in JSON first, then chat freely.
      </div>
      <div id="messages" className="border rounded p-3 mb-3" aria-live="polite">
        {messages.map((m, i) => (
          <div key={i}>
            <span className="sender">{m.sender}:</span> {m.content}
          </div>
        ))}
      </div>
      <div id="inputArea" className="mb-3">
        <textarea
          className="form-control mb-2"
          value={newMessage}
          onChange={e => setNewMessage(e.target.value)}
          placeholder="Type your message..."
          aria-label="Message text"
        ></textarea>
        <button className="btn btn-primary" onClick={sendMessage} aria-label="Send message">Send</button>
      </div>
    </div>
  );
}

ReactDOM.render(<ChatApp />, document.getElementById('app'));
</script>
<script
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-Q2gyqgtD+2W2cUBUlwFh5sp/jV6elgC97gJnIFsl0cl3aG5i5C5bdbWQqWIrP3rV"
  crossorigin="anonymous"
></script>
</body>
</html>
