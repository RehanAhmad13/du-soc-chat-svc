<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DU SOC Chat</title>
<style>
body { font-family: Arial, sans-serif; margin: 1em; }
#messages { border: 1px solid #ccc; padding: 1em; height: 300px; overflow-y: scroll; }
.sender { font-weight: bold; }
#inputArea { margin-top: 1em; }
textarea { width: 100%; height: 4em; }
li { cursor: pointer; }
</style>
<script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
</head>
<body>
<div id="app"></div>
<script type="text/babel">
const { useState } = React;

function ChatApp() {
  const [token, setToken] = useState(null);
  const [threads, setThreads] = useState([]);
  const [currentThread, setCurrentThread] = useState(null);
  const [messages, setMessages] = useState([]);
  const [socket, setSocket] = useState(null);
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [newMessage, setNewMessage] = useState('');

  const login = () => {
    fetch('/api/chat/token/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    })
      .then(r => r.json())
      .then(data => {
        if (data.token) {
          setToken(data.token);
          loadThreads(data.token);
        } else {
          alert('Login failed');
        }
      });
  };

  const loadThreads = (tok = token) => {
    fetch('/api/chat/threads/', { headers: { 'Authorization': 'Bearer ' + tok } })
      .then(r => r.json())
      .then(setThreads);
  };

  const openThread = (thread) => {
    setCurrentThread(thread);
    setMessages([]);
    if (socket) socket.close();
    const ws = new WebSocket(`ws://${location.host}/ws/chat/${thread.id}/?token=${token}`);
    ws.onmessage = e => {
      const data = JSON.parse(e.data);
      if (data.type === 'message') {
        setMessages(prev => [...prev, { sender: data.sender, content: data.content }]);
      }
    };
    setSocket(ws);
    fetch(`/api/chat/threads/${thread.id}/`, { headers: { 'Authorization': 'Bearer ' + token } })
      .then(r => r.json())
      .then(d => {
        const msgs = d.messages || [];
        setMessages(msgs.map(m => ({ sender: m.sender, content: m.content })));
      });
  };

  const sendMessage = () => {
    if (!newMessage || !socket) return;
    socket.send(JSON.stringify({ type: 'message', content: newMessage }));
    setNewMessage('');
  };

  if (!token) {
    return (
      <div id="login">
        <input value={username} onChange={e => setUsername(e.target.value)} placeholder="Username" />
        <input type="password" value={password} onChange={e => setPassword(e.target.value)} placeholder="Password" />
        <button onClick={login}>Login</button>
      </div>
    );
  }

  if (!currentThread) {
    return (
      <div>
        <h1>DU SOC Chat</h1>
        <h2>Threads</h2>
        <ul>
          {threads.map(t => (
            <li key={t.id} onClick={() => openThread(t)}>{t.incident_id} (ID {t.id})</li>
          ))}
        </ul>
      </div>
    );
  }

  return (
    <div>
      <h1>DU SOC Chat</h1>
      <h2>Incident {currentThread.incident_id}</h2>
      <div id="instructions" style={{ color: '#555' }}>Please answer any structured prompts in JSON first, then chat freely.</div>
      <div id="messages">
        {messages.map((m, i) => (
          <div key={i}><span className="sender">{m.sender}:</span> {m.content}</div>
        ))}
      </div>
      <div id="inputArea">
        <textarea value={newMessage} onChange={e => setNewMessage(e.target.value)} placeholder="Type your message..."></textarea>
        <button onClick={sendMessage}>Send</button>
      </div>
    </div>
  );
}

ReactDOM.render(<ChatApp />, document.getElementById('app'));
</script>
</body>
</html>
